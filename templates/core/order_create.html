{% extends 'base.html' %}
{% block title %}Nova Ordem de Serviço · {{ GARAGE_NAME }}{% endblock %}

{% block content %}
<h1 class="h3 mb-4">Abrir nova ordem de serviço</h1>
<form method="post" novalidate>
    {% csrf_token %}

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-primary text-white">
            <strong>1. Cliente</strong> <span class="small d-block">Escolha um cliente existente ou informe os dados abaixo.</span>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label" for="existing_customer">Cliente existente</label>
                <select class="form-select" name="existing_customer" id="existing_customer">
                    <option value="">-- Novo cliente --</option>
                    {% for customer in existing_customers %}
                        <option value="{{ customer.id }}" {% if selected_customer and customer.id|stringformat:'s' == selected_customer %}selected{% endif %}>{{ customer.name }}{% if customer.phone %} · {{ customer.phone }}{% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="row g-3">
                {% for field in customer_form %}
                    <div class="col-md-6">
                        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                        {% for error in field.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-primary text-white">
            <strong>2. Veículo</strong> <span class="small d-block">Reaproveite um veículo cadastrado ou inclua um novo.</span>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label" for="existing_vehicle">Veículo existente</label>
                <select class="form-select" name="existing_vehicle" id="existing_vehicle">
                    <option value="">-- Novo veículo --</option>
                    {% for vehicle in existing_vehicles %}
                        <option value="{{ vehicle.id }}" {% if selected_vehicle and vehicle.id|stringformat:'s' == selected_vehicle %}selected{% endif %}>
                            {{ vehicle.customer.name }} · {{ vehicle.brand }} {{ vehicle.model }} ({{ vehicle.plate|default:'sem placa' }})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="row g-3">
                {% for field in vehicle_form %}
                    <div class="col-md-6">
                        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                        {% for error in field.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-primary text-white">
            <strong>3. Dados da ordem</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
                {% for field in order_form %}
                    {% if field.name in issue_priority_fields %}
                        <div class="col-md-6">
                            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% for error in field.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% else %}
                        {{ field }}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'core:order_list' %}">Cancelar</a>
        <button class="btn btn-primary" type="submit"><i class="bi bi-save me-1"></i>Salvar ordem</button>
    </div>
</form>
{% endblock %}
