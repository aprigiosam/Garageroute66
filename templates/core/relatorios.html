{% extends "base.html" %}

{% block title %}Relatórios · Oficina Pro{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Relatórios</li>
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="bi bi-graph-up text-primary me-2"></i>Relatórios
        </h1>
        <p class="text-muted">Análise de dados e relatórios gerenciais</p>
    </div>
    <div>
        <button type="button" class="btn btn-primary" onclick="exportarRelatorio()">
            <i class="bi bi-download me-2"></i>Exportar
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Filtros -->
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-funnel me-2"></i>Filtros do Relatório
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="relatorioForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Top 10 Clientes</h6>
                                        <p class="mb-1 small text-muted">Clientes com maior faturamento</p>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="gerarRelatorioTop10()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Serviços Mais Realizados</h6>
                                        <p class="mb-1 small text-muted">Análise de tipos de serviço</p>
                                    </div>
                                    <button class="btn btn-outline-success btn-sm" onclick="gerarRelatorioServicos()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Produtividade Mensal</h6>
                                        <p class="mb-1 small text-muted">OS por mês e técnico</p>
                                    </div>
                                    <button class="btn btn-outline-info btn-sm" onclick="gerarRelatorioProdutividade()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Tempo Médio de Serviço</h6>
                                        <p class="mb-1 small text-muted">Análise de eficiência</p>
                                    </div>
                                    <button class="btn btn-outline-warning btn-sm" onclick="gerarRelatorioTempo()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Veículos por Marca</h6>
                                        <p class="mb-1 small text-muted">Distribuição de marcas</p>
                                    </div>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="gerarRelatorioMarcas()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Comparativo Anual</h6>
                                        <p class="mb-1 small text-muted">Este ano vs ano anterior</p>
                                    </div>
                                    <button class="btn btn-outline-danger btn-sm" onclick="gerarRelatorioComparativo()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Agendamentos</h6>
                                        <p class="mb-1 small text-muted">Taxa de comparecimento</p>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="gerarRelatorioAgendamentos()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Inadimplência</h6>
                                        <p class="mb-1 small text-muted">Análise de pagamentos</p>
                                    </div>
                                    <button class="btn btn-outline-warning btn-sm" onclick="gerarRelatorioInadimplencia()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Relatório Completo</h6>
                                        <p class="mb-1 small text-muted">Análise executiva</p>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="gerarRelatorioCompleto()">
                                        <i class="bi bi-play"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estatísticas Rápidas -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="bi bi-currency-dollar fs-2 mb-2"></i>
                <h4>R$ 0,00</h4>
                <small>Faturamento Este Mês</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="bi bi-clipboard-check fs-2 mb-2"></i>
                <h4>0</h4>
                <small>OS Concluídas</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="bi bi-people fs-2 mb-2"></i>
                <h4>0</h4>
                <small>Clientes Ativos</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="bi bi-graph-up fs-2 mb-2"></i>
                <h4>0%</h4>
                <small>Crescimento</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Relatório rápido
function relatorioRapido(tipo, periodo) {
    document.getElementById('{{ form.tipo_relatorio.id_for_label }}').value = tipo;
    document.getElementById('{{ form.periodo.id_for_label }}').value = periodo;
    document.getElementById('relatorioForm').submit();
}

// Exportar relatório
function exportarRelatorio() {
    const form = document.getElementById('relatorioForm');
    if (!form.checkValidity()) {
        alert('Por favor, gere um relatório primeiro');
        return;
    }
    
    // Criar formulário para exportação
    const exportForm = document.createElement('form');
    exportForm.method = 'POST';
    exportForm.action = window.location.href + '?export=true';
    
    // Copiar campos do formulário original
    const formData = new FormData(form);
    for (let [key, value] of formData.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        exportForm.appendChild(input);
    }
    
    document.body.appendChild(exportForm);
    exportForm.submit();
    document.body.removeChild(exportForm);
}

// Controle de campos de data personalizada
document.addEventListener('DOMContentLoaded', function() {
    const periodoSelect = document.getElementById('{{ form.periodo.id_for_label }}');
    const dataInicio = document.getElementById('{{ form.data_inicio.id_for_label }}');
    const dataFim = document.getElementById('{{ form.data_fim.id_for_label }}');
    
    function toggleCustomDates() {
        const isCustom = periodoSelect.value === 'personalizado';
        dataInicio.disabled = !isCustom;
        dataFim.disabled = !isCustom;
        
        if (isCustom) {
            dataInicio.required = true;
            dataFim.required = true;
        } else {
            dataInicio.required = false;
            dataFim.required = false;
            dataInicio.value = '';
            dataFim.value = '';
        }
    }
    
    periodoSelect.addEventListener('change', toggleCustomDates);
    toggleCustomDates(); // Inicializar
});

// Gerar gráfico de faturamento
{% if dados and dados.tipo == 'Faturamento' %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('faturamentoChart').getContext('2d');
    
    // Dados do gráfico (seria gerado pelo backend)
    const chartData = {
        labels: [
            {% for ordem in dados.ordens|slice:":10" %}
                '{{ ordem.data_abertura|date:"d/m" }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Faturamento Diário (R$)',
            data: [
                {% for ordem in dados.ordens|slice:":10" %}
                    {{ ordem.total|floatformat:2 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: 'rgb(40, 167, 69)',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    };
    
    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            }
        }
    });
});
{% endif %}

// Funções para relatórios predefinidos
function gerarRelatorioTop10() {
    alert('Relatório Top 10 Clientes será implementado');
}

function gerarRelatorioServicos() {
    alert('Relatório de Serviços será implementado');
}

function gerarRelatorioProdutividade() {
    alert('Relatório de Produtividade será implementado');
}

function gerarRelatorioTempo() {
    alert('Relatório de Tempo será implementado');
}

function gerarRelatorioMarcas() {
    alert('Relatório por Marcas será implementado');
}

function gerarRelatorioComparativo() {
    alert('Relatório Comparativo será implementado');
}

function gerarRelatorioAgendamentos() {
    alert('Relatório de Agendamentos será implementado');
}

function gerarRelatorioInadimplencia() {
    alert('Relatório de Inadimplência será implementado');
}

function gerarRelatorioCompleto() {
    alert('Relatório Completo será implementado');
}
</script>
{% endblock %} class="col-md-3">
                            <label for="{{ form.tipo_relatorio.id_for_label }}" class="form-label">
                                <i class="bi bi-clipboard-data me-1"></i>{{ form.tipo_relatorio.label }}
                            </label>
                            {{ form.tipo_relatorio }}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form.periodo.id_for_label }}" class="form-label">
                                <i class="bi bi-calendar-range me-1"></i>{{ form.periodo.label }}
                            </label>
                            {{ form.periodo }}
                        </div>
                        
                        <div class="col-md-2">
                            <label for="{{ form.data_inicio.id_for_label }}" class="form-label">{{ form.data_inicio.label }}</label>
                            {{ form.data_inicio }}
                        </div>
                        
                        <div class="col-md-2">
                            <label for="{{ form.data_fim.id_for_label }}" class="form-label">{{ form.data_fim.label }}</label>
                            {{ form.data_fim }}
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search me-2"></i>Gerar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Resultados do Relatório -->
    {% if dados %}
    <div class="col-12">
        {% if dados.tipo == 'Faturamento' %}
        <!-- Relatório de Faturamento -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-currency-dollar me-2"></i>{{ dados.tipo }}
                </h5>
                <span class="badge bg-primary">{{ dados.periodo_texto }}</span>
            </div>
            <div class="card-body">
                <!-- Resumo Executivo -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-success">R$ {{ dados.total_faturamento|floatformat:2 }}</h3>
                            <small class="text-muted">Faturamento Total</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-primary">{{ dados.total_ordens }}</h3>
                            <small class="text-muted">Ordens Entregues</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-info">R$ {{ dados.ticket_medio|floatformat:2 }}</h3>
                            <small class="text-muted">Ticket Médio</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-warning">{{ dados.total_ordens|default:0 }}</h3>
                            <small class="text-muted">Clientes Atendidos</small>
                        </div>
                    </div>
                </div>
                
                <!-- Gráfico de Faturamento -->
                <div class="mb-4">
                    <canvas id="faturamentoChart" height="100"></canvas>
                </div>
                
                <!-- Tabela Detalhada -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>OS #</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Veículo</th>
                                <th class="text-end">Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ordem in dados.ordens %}
                            <tr>
                                <td>
                                    <a href="{% url 'core:detalhes_ordem_servico' ordem.id %}" class="text-decoration-none">
                                        {{ ordem.numero_os }}
                                    </a>
                                </td>
                                <td>{{ ordem.data_abertura|date:"d/m/Y" }}</td>
                                <td>{{ ordem.veiculo.cliente.nome }}</td>
                                <td>{{ ordem.veiculo.placa }} - {{ ordem.veiculo.marca }}</td>
                                <td class="text-end">
                                    <strong class="text-success">R$ {{ ordem.total|floatformat:2 }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ ordem.get_status_display }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="4">Total:</th>
                                <th class="text-end">
                                    <strong class="text-success fs-5">R$ {{ dados.total_faturamento|floatformat:2 }}</strong>
                                </th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- Estado Inicial -->
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-graph-up fs-1 text-muted d-block mb-3"></i>
                <h5>Selecione os Filtros</h5>
                <p class="text-muted">Configure os filtros acima e clique em "Gerar" para visualizar o relatório.</p>
                
                <!-- Relatórios Rápidos -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card border">
                            <div class="card-body">
                                <i class="bi bi-currency-dollar fs-2 text-success d-block mb-2"></i>
                                <h6>Faturamento Mensal</h6>
                                <button class="btn btn-outline-success btn-sm" onclick="relatorioRapido('faturamento', 'mes')">
                                    Gerar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card border">
                            <div class="card-body">
                                <i class="bi bi-people fs-2 text-primary d-block mb-2"></i>
                                <h6>Clientes Ativos</h6>
                                <button class="btn btn-outline-primary btn-sm" onclick="relatorioRapido('clientes', 'mes')">
                                    Gerar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card border">
                            <div class="card-body">
                                <i class="bi bi-clipboard-check fs-2 text-info d-block mb-2"></i>
                                <h6>Ordens de Serviço</h6>
                                <button class="btn btn-outline-info btn-sm" onclick="relatorioRapido('servicos', 'mes')">
                                    Gerar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card border">
                            <div class="card-body">
                                <i class="bi bi-car-front fs-2 text-warning d-block mb-2"></i>
                                <h6>Veículos</h6>
                                <button class="btn btn-outline-warning btn-sm" onclick="relatorioRapido('veiculos', 'mes')">
                                    Gerar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Relatórios Predefinidos -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bookmark me-2"></i>Relatórios Predefinidos
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div