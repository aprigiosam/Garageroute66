{% extends "base.html" %}

{% block title %}Editar OS #{{ ordem.numero_os }} · Oficina Pro{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'core:listar_ordens_servico' %}">Ordens de Serviço</a>
</li>
<li class="breadcrumb-item">
    <a href="{% url 'core:detalhes_ordem_servico' ordem.id %}">OS #{{ ordem.numero_os }}</a>
</li>
<li class="breadcrumb-item active">Editar</li>
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="bi bi-pencil-square text-primary me-2"></i>
            Editar OS #{{ ordem.numero_os }}
        </h1>
        <p class="text-muted">{{ ordem.veiculo.placa }} - {{ ordem.cliente.nome }}</p>
    </div>
    <div>
        <a href="{% url 'core:detalhes_ordem_servico' ordem.id %}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-2"></i>Voltar
        </a>
        <a href="{% url 'core:listar_ordens_servico' %}" class="btn btn-outline-info">
            <i class="bi bi-list me-2"></i>Lista de OS
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<form method="post" id="ordemServicoForm">
    {% csrf_token %}
    <div class="row">
        <!-- Formulário Principal -->
        <div class="col-lg-8">
            <!-- Informações Básicas -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Informações Básicas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.veiculo.id_for_label }}" class="form-label">
                                <i class="bi bi-car-front me-1"></i>{{ form.veiculo.label }}
                            </label>
                            {{ form.veiculo }}
                            {% for error in form.veiculo.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                <i class="bi bi-flag me-1"></i>Status
                            </label>
                            {{ form.status }}
                            {% for error in form.status.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form.prioridade.id_for_label }}" class="form-label">
                                <i class="bi bi-exclamation-triangle me-1"></i>{{ form.prioridade.label }}
                            </label>
                            {{ form.prioridade }}
                            {% for error in form.prioridade.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.responsavel_tecnico.id_for_label }}" class="form-label">
                                <i class="bi bi-person-gear me-1"></i>{{ form.responsavel_tecnico.label }}
                            </label>
                            {{ form.responsavel_tecnico }}
                            {% for error in form.responsavel_tecnico.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form.km_entrada.id_for_label }}" class="form-label">
                                <i class="bi bi-speedometer me-1"></i>{{ form.km_entrada.label }}
                            </label>
                            {{ form.km_entrada }}
                            {% for error in form.km_entrada.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form.prazo_entrega.id_for_label }}" class="form-label">
                                <i class="bi bi-calendar-event me-1"></i>{{ form.prazo_entrega.label }}
                            </label>
                            {{ form.prazo_entrega }}
                            {% for error in form.prazo_entrega.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Descrições -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-chat-text me-2"></i>Descrições
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="{{ form.descricao_problema.id_for_label }}" class="form-label">
                                <i class="bi bi-exclamation-circle me-1"></i>{{ form.descricao_problema.label }}
                            </label>
                            {{ form.descricao_problema }}
                            {% for error in form.descricao_problema.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-12">
                            <label for="{{ form.diagnostico.id_for_label }}" class="form-label">
                                <i class="bi bi-search me-1"></i>{{ form.diagnostico.label }}
                            </label>
                            {{ form.diagnostico }}
                            {% for error in form.diagnostico.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-12">
                            <label for="{{ form.solucao.id_for_label }}" class="form-label">
                                <i class="bi bi-tools me-1"></i>Solução Aplicada
                            </label>
                            {{ form.solucao }}
                            {% for error in form.solucao.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Valores -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-currency-dollar me-2"></i>Valores
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="{{ form.valor_mao_obra.id_for_label }}" class="form-label">
                                <i class="bi bi-person-workspace me-1"></i>{{ form.valor_mao_obra.label }}
                            </label>
                            {{ form.valor_mao_obra }}
                            {% for error in form.valor_mao_obra.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form.valor_pecas.id_for_label }}" class="form-label">
                                <i class="bi bi-gear me-1"></i>{{ form.valor_pecas.label }}
                            </label>
                            {{ form.valor_pecas }}
                            {% for error in form.valor_pecas.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form.valor_terceiros.id_for_label }}" class="form-label">
                                <i class="bi bi-people me-1"></i>{{ form.valor_terceiros.label }}
                            </label>
                            {{ form.valor_terceiros }}
                            {% for error in form.valor_terceiros.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-3">
                            <label for="{{ form.desconto.id_for_label }}" class="form-label">
                                <i class="bi bi-percent me-1"></i>{{ form.desconto.label }}
                            </label>
                            {{ form.desconto }}
                            {% for error in form.desconto.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-12">
                            <div class="alert alert-info d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-calculator me-2"></i>Total da OS:</span>
                                <strong class="fs-5" id="totalCalculado">R$ {{ ordem.total|floatformat:2 }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Itens da OS -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-check me-2"></i>Itens e Serviços
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFormsetRow()">
                        <i class="bi bi-plus-circle me-1"></i>Adicionar Item
                    </button>
                </div>
                <div class="card-body">
                    <div id="formset-container">
                        {{ formset.management_form }}
                        {% for form_item in formset %}
                        <div class="formset-row border rounded p-3 mb-3">
                            {% for hidden in form_item.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Descrição</label>
                                    {{ form_item.descricao }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Tipo</label>
                                    {{ form_item.tipo }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Quantidade</label>
                                    {{ form_item.quantidade }}
                                </div>