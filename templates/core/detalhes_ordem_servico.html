{% extends "base.html" %}

{% block title %}OS #{{ ordem.numero_os }} · Oficina Pro{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'core:listar_ordens_servico' %}">Ordens de Serviço</a>
</li>
<li class="breadcrumb-item active">OS #{{ ordem.numero_os }}</li>
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="bi bi-clipboard-data text-primary me-2"></i>
            Ordem de Serviço #{{ ordem.numero_os }}
        </h1>
        <div class="d-flex align-items-center mt-2">
            <span class="badge 
                {% if ordem.status == 'ABERTA' %}bg-primary
                {% elif ordem.status == 'EM_ANDAMENTO' %}bg-warning
                {% elif ordem.status == 'CONCLUIDA' %}bg-success
                {% elif ordem.status == 'ENTREGUE' %}bg-info
                {% elif ordem.status == 'CANCELADA' %}bg-danger
                {% else %}bg-secondary
                {% endif %} me-2">
                {{ ordem.get_status_display }}
            </span>
            <span class="badge 
                {% if ordem.prioridade == 'URGENTE' %}bg-danger
                {% elif ordem.prioridade == 'ALTA' %}bg-warning text-dark
                {% elif ordem.prioridade == 'NORMAL' %}bg-primary
                {% else %}bg-secondary
                {% endif %} me-2">
                {{ ordem.get_prioridade_display }}
            </span>
            {% if ordem.prazo_vencido %}
                <span class="badge bg-warning text-dark">
                    <i class="bi bi-exclamation-triangle"></i> Prazo Vencido
                </span>
            {% endif %}
        </div>
    </div>
    <div>
        <a href="{% url 'core:listar_ordens_servico' %}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-2"></i>Voltar
        </a>
        <a href="{% url 'core:editar_ordem_servico' ordem.id %}" class="btn btn-warning me-2">
            <i class="bi bi-pencil me-2"></i>Editar
        </a>
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-gear me-2"></i>Ações
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="#" onclick="printOS()">
                        <i class="bi bi-printer me-2"></i>Imprimir OS
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" onclick="exportPDF()">
                        <i class="bi bi-file-pdf me-2"></i>Exportar PDF
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item" href="#" onclick="sendEmail()">
                        <i class="bi bi-envelope me-2"></i>Enviar por E-mail
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" onclick="duplicateOS()">
                        <i class="bi bi-copy me-2"></i>Duplicar OS
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="{{ public_url }}" target="_blank">
                        <i class="bi bi-link-45deg me-2"></i>Link do orçamento
                    </a>
                </li>
                {% if ordem.status != 'CANCELADA' %}
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item text-danger" href="#" onclick="cancelOS()">
                        <i class="bi bi-x-circle me-2"></i>Cancelar OS
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Informações Principais -->
    <div class="col-lg-8">
        <!-- Dados do Cliente e Veículo -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>Informações Gerais
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Cliente</h6>
                        <div class="mb-3">
                            <h5 class="mb-1">{{ ordem.cliente.nome }}</h5>
                            <div class="text-muted">
                                <div><i class="bi bi-telephone me-1"></i>{{ ordem.cliente.telefone }}</div>
                                <div><i class="bi bi-envelope me-1"></i>{{ ordem.cliente.email }}</div>
                                <div><i class="bi bi-card-text me-1"></i>{{ ordem.cliente.cpf }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Veículo</h6>
                        <div class="mb-3">
                            <h5 class="mb-1">{{ ordem.veiculo.placa }}</h5>
                            <div class="text-muted">
                                <div><i class="bi bi-car-front me-1"></i>{{ ordem.veiculo.marca }} {{ ordem.veiculo.modelo }}</div>
                                <div><i class="bi bi-calendar me-1"></i>Ano: {{ ordem.veiculo.ano }}</div>
                                <div><i class="bi bi-palette me-1"></i>Cor: {{ ordem.veiculo.cor }}</div>
                                {% if ordem.km_entrada %}
                                    <div><i class="bi bi-speedometer me-1"></i>KM: {{ ordem.km_entrada|floatformat:0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if fotos %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bi bi-camera me-2"></i>Fotos de check-in</h5>
                <span class="badge bg-secondary">{{ fotos|length }} foto(s)</span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for foto in fotos %}
                        <div class="col-md-4">
                            <div class="ratio ratio-4x3 border rounded overflow-hidden">
                                <img src="{{ foto.imagem.url }}" alt="Foto OS" class="object-fit-cover w-100 h-100">
                            </div>
                            {% if foto.legenda %}
                                <p class="small text-muted mt-2">{{ foto.legenda }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Descrição do Problema -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-exclamation-circle me-2"></i>Problema Relatado
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ ordem.descricao_problema|linebreaks }}</p>
            </div>
        </div>

        <!-- Diagnóstico -->
        {% if ordem.diagnostico %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-search me-2"></i>Diagnóstico
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ ordem.diagnostico|linebreaks }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Solução -->
        {% if ordem.solucao %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-tools me-2"></i>Solução Aplicada
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ ordem.solucao|linebreaks }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Itens da Ordem de Serviço -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-check me-2"></i>Itens e Serviços
                </h5>
            </div>
            <div class="card-body">
                {% if ordem.itens.exists %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th>Tipo</th>
                                    <th class="text-end">Qtd</th>
                                    <th class="text-end">Valor Unit.</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in ordem.itens.all %}
                                <tr>
                                    <td>{{ item.descricao }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if item.tipo == 'SERVICO' %}bg-primary
                                            {% elif item.tipo == 'PECA' %}bg-warning text-dark
                                            {% else %}bg-info
                                            {% endif %}">
                                            {{ item.get_tipo_display }}
                                        </span>
                                    </td>
                                    <td class="text-end">{{ item.quantidade }}</td>
                                    <td class="text-end">R$ {{ item.valor_unitario|floatformat:2 }}</td>
                                    <td class="text-end"><strong>R$ {{ item.valor_total|floatformat:2 }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                        <p>Nenhum item cadastrado para esta ordem de serviço.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Observações -->
        {% if ordem.observacoes %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-chat-text me-2"></i>Observações
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ ordem.observacoes|linebreaks }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Observações Internas -->
        {% if ordem.observacoes_internas %}
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning bg-opacity-10">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lock me-2"></i>Observações Internas
                    <small class="text-muted">(Uso interno)</small>
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ ordem.observacoes_internas|linebreaks }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar com Informações Complementares -->
    <div class="col-lg-4">
        <!-- Resumo Financeiro -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-currency-dollar me-2"></i>Resumo Financeiro
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Total aprovado:</span>
                    <strong>R$ {{ total_aprovado|floatformat:2 }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Total pago:</span>
                    <strong class="{% if saldo_pendente == 0 %}text-success{% else %}text-warning{% endif %}">R$ {{ total_pago|floatformat:2 }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Saldo pendente:</span>
                    <strong class="{% if saldo_pendente == 0 %}text-success{% else %}text-danger{% endif %}">R$ {{ saldo_pendente|floatformat:2 }}</strong>
                </div>

                {% if saldo_pendente > 0 %}
                <div class="alert alert-warning small" role="alert">
                    Ainda faltam R$ {{ saldo_pendente|floatformat:2 }} para quitar esta OS.
                </div>
                {% else %}
                <div class="alert alert-success small" role="alert">
                    Pagamentos quitados. OS liberada para entrega.
                </div>
                {% endif %}

                <div class="border-top pt-3 mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Mão de obra:</span>
                        <strong>R$ {{ ordem.valor_mao_obra|floatformat:2 }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Peças:</span>
                        <strong>R$ {{ ordem.valor_pecas|floatformat:2 }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Terceiros:</span>
                        <strong>R$ {{ ordem.valor_terceiros|floatformat:2 }}</strong>
                    </div>
                    {% if ordem.desconto > 0 %}
                    <div class="d-flex justify-content-between mb-2 text-danger">
                        <span>Desconto:</span>
                        <strong>- R$ {{ ordem.desconto|floatformat:2 }}</strong>
                    </div>
                    {% endif %}
                </div>

                <button class="btn btn-outline-primary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#registrarPagamento" aria-expanded="false" aria-controls="registrarPagamento">
                    <i class="bi bi-plus-circle me-1"></i>Registrar pagamento
                </button>

                <div class="collapse mt-3" id="registrarPagamento">
                    <form method="post" action="{% url 'core:registrar_pagamento_ordem' ordem.id %}">
                        {% csrf_token %}
                        {% if pagamento_form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in pagamento_form.non_field_errors %}<div>{{ error }}</div>{% endfor %}
                            </div>
                        {% endif %}
                        {% for field in pagamento_form %}
                            <div class="mb-3">
                                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                {% for error in field.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                        {% endfor %}
                        <button class="btn btn-primary w-100" type="submit">
                            <i class="bi bi-cash-coin me-1"></i>Salvar pagamento
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Pagamentos -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="bi bi-receipt me-2"></i>Pagamentos Registrados
                </h6>
                <span class="badge bg-secondary">{{ pagamentos|length }}</span>
            </div>
            <div class="card-body">
                {% if pagamentos %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Valor</th>
                                    <th>Forma</th>
                                    <th>Status</th>
                                    <th>Recebido por</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pagamento in pagamentos %}
                                <tr>
                                    <td>{{ pagamento.data_pagamento|date:"d/m/Y H:i" }}</td>
                                    <td>R$ {{ pagamento.valor|floatformat:2 }}</td>
                                    <td>{{ pagamento.get_forma_pagamento_display }}</td>
                                    <td>
                                        <span class="badge {% if pagamento.status == pagamento.Status.PAGO %}bg-success{% elif pagamento.status == pagamento.Status.PENDENTE %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                            {{ pagamento.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ pagamento.recebido_por|default:"-" }}</td>
                                </tr>
                                {% if pagamento.observacao %}
                                <tr>
                                    <td colspan="5" class="text-muted small">{{ pagamento.observacao }}</td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Nenhum pagamento registrado até o momento.</p>
                {% endif %}
            </div>
        </div>

        <!-- Cronologia -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-clock-history me-2"></i>Cronologia
                </h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">OS Aberta</h6>
                            <small class="text-muted">{{ ordem.data_abertura|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    
                    {% if ordem.data_orcamento %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-info"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Orçamento</h6>
                            <small class="text-muted">{{ ordem.data_orcamento|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if ordem.data_aprovacao %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Aprovado</h6>
                            <small class="text-muted">{{ ordem.data_aprovacao|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if ordem.data_inicio %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Iniciado</h6>
                            <small class="text-muted">{{ ordem.data_inicio|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if ordem.data_conclusao %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Concluído</h6>
                            <small class="text-muted">{{ ordem.data_conclusao|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if ordem.data_entrega %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Entregue</h6>
                            <small class="text-muted">{{ ordem.data_entrega|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if ordem.prazo_entrega %}
                <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted d-block">Prazo de entrega:</small>
                    <strong class="{% if ordem.prazo_vencido %}text-danger{% else %}text-info{% endif %}">
                        {{ ordem.prazo_entrega|date:"d/m/Y H:i" }}
                    </strong>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Responsável Técnico -->
        {% if ordem.responsavel_tecnico %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-person-gear me-2"></i>Responsável Técnico
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                         style="width: 40px; height: 40px;">
                        <i class="bi bi-person text-white"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">{{ ordem.responsavel_tecnico.get_full_name|default:ordem.responsavel_tecnico.username }}</h6>
                        <small class="text-muted">Técnico responsável</small>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Estatísticas de Tempo -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-stopwatch me-2"></i>Tempos
                </h6>
            </div>
            <div class="card-body">
                {% if ordem.tempo_execucao %}
                <div class="d-flex justify-content-between mb-2">
                    <span>Tempo de execução:</span>
                    <strong>{{ ordem.tempo_execucao.days }} dias</strong>
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between mb-2">
                    <span>Idade da OS:</span>
                    <strong>{{ ordem.data_abertura|timesince }}</strong>
                </div>
                
                {% if ordem.prazo_entrega %}
                <div class="d-flex justify-content-between">
                    <span>Status do prazo:</span>
                    {% if ordem.status == 'ENTREGUE' %}
                        <span class="badge bg-success">Entregue</span>
                    {% elif ordem.prazo_vencido %}
                        <span class="badge bg-danger">Vencido</span>
                    {% else %}
                        <span class="badge bg-warning">No prazo</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightning me-2"></i>Ações Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="updateStatus()">
                        <i class="bi bi-arrow-repeat me-2"></i>Atualizar Status
                    </button>
                    
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="addNote()">
                        <i class="bi bi-chat-plus me-2"></i>Adicionar Observação
                    </button>
                    
                    <a href="{% url 'core:abrir_ordem_servico' %}?veiculo={{ ordem.veiculo.id }}" 
                       class="btn btn-outline-success btn-sm">
                        <i class="bi bi-plus-circle me-2"></i>Nova OS para Veículo
                    </a>
                    
                    <a href="{% url 'core:listar_ordens_servico' %}?cliente={{ ordem.cliente.id }}" 
                       class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-search me-2"></i>Outras OS do Cliente
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Histórico de Mudanças -->
{% if historico %}
<div class="card mt-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-journal-text me-2"></i>Histórico de Mudanças
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Status Anterior</th>
                        <th>Status Novo</th>
                        <th>Usuário</th>
                        <th>Observação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for evento in historico %}
                    <tr>
                        <td>{{ evento.data_mudanca|date:"d/m/Y H:i" }}</td>
                        <td>
                            {% if evento.status_anterior %}
                                <span class="badge bg-secondary">{{ evento.get_status_anterior_display }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ evento.get_status_novo_display }}</span>
                        </td>
                        <td>{% if evento.usuario %}{{ evento.usuario.get_full_name|default:evento.usuario.username }}{% else %}<span class="text-muted">Sistema</span>{% endif %}</td>
                        <td>{{ evento.observacao|default:'-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Modals -->
<!-- Modal de Atualização de Status -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Atualizar Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusUpdateForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Novo Status:</label>
                        <select class="form-select" name="status" required>
                            <option value="">Selecione...</option>
                            <option value="ABERTA" {% if ordem.status == 'ABERTA' %}disabled{% endif %}>Aberta</option>
                            <option value="ORCAMENTO" {% if ordem.status == 'ORCAMENTO' %}disabled{% endif %}>Orçamento</option>
                            <option value="APROVADA" {% if ordem.status == 'APROVADA' %}disabled{% endif %}>Aprovada</option>
                            <option value="EM_ANDAMENTO" {% if ordem.status == 'EM_ANDAMENTO' %}disabled{% endif %}>Em Andamento</option>
                            <option value="AGUARDANDO_PECA" {% if ordem.status == 'AGUARDANDO_PECA' %}disabled{% endif %}>Aguardando Peça</option>
                            <option value="CONCLUIDA" {% if ordem.status == 'CONCLUIDA' %}disabled{% endif %}>Concluída</option>
                            <option value="ENTREGUE" {% if ordem.status == 'ENTREGUE' %}disabled{% endif %}>Entregue</option>
                            <option value="CANCELADA" {% if ordem.status == 'CANCELADA' %}disabled{% endif %}>Cancelada</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observação:</label>
                        <textarea class="form-control" name="observacao" rows="3" 
                                  placeholder="Descreva o motivo da mudança de status..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmStatusUpdate()">Atualizar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.timeline {
    position: relative;
    padding: 0;
    list-style: none;
}

.timeline::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 8px;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
    padding-left: 30px;
}

.timeline-marker {
    position: absolute;
    left: -8px;
    top: 0;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid #fff;
    z-index: 1;
}

.timeline-content h6 {
    margin-bottom: 5px;
    font-size: 14px;
}

.timeline-content small {
    font-size: 12px;
}

@media print {
    .btn, .dropdown, .card-header .bi-gear {
        display: none !important;
    }
    
    .card {
        border: 1px solid #dee2e6 !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function updateStatus() {
    const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
    modal.show();
}

function confirmStatusUpdate() {
    const form = document.getElementById('statusUpdateForm');
    const formData = new FormData(form);
    
    if (!formData.get('status')) {
        alert('Selecione um status');
        return;
    }
    
    fetch(`{% url 'core:atualizar_status_ordem' ordem.id %}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atualizar status');
    });
}

function addNote() {
    const note = prompt('Digite a observação:');
    if (note && note.trim()) {
        // Implementar adição de nota
        alert('Funcionalidade será implementada');
    }
}

function printOS() {
    window.print();
}

function exportPDF() {
    // Implementar exportação PDF
    alert('Funcionalidade de exportação PDF será implementada');
}

function sendEmail() {
    if (confirm('Enviar OS por e-mail para o cliente?')) {
        // Implementar envio por e-mail
        alert('Funcionalidade de envio por e-mail será implementada');
    }
}

function duplicateOS() {
    if (confirm('Duplicar esta OS? Uma nova OS será criada com os mesmos dados.')) {
        // Implementar duplicação
        alert('Funcionalidade de duplicação será implementada');
    }
}

function cancelOS() {
    const reason = prompt('Motivo do cancelamento:');
    if (reason && reason.trim()) {
        if (confirm('Tem certeza que deseja cancelar esta OS?')) {
            // Implementar cancelamento
            alert('OS será cancelada: ' + reason);
        }
    }
}

// Auto-refresh a cada 30 segundos se a OS estiver em andamento
{% if ordem.status == 'EM_ANDAMENTO' %}
setInterval(function() {
    if (!document.hidden) {
        location.reload();
    }
}, 30000);
{% endif %}
</script>
{% endblock %}
