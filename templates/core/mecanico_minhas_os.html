{% extends "base.html" %}

{% block title %}Minhas Ordens · Garage Route 66{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Minhas ordens</li>
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0"><i class="bi bi-wrench-adjustable text-primary me-2"></i>Minhas ordens</h1>
        <p class="text-muted mb-0">Ordens atribuídas a você para diagnóstico e execução.</p>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .mechanic-status-scroll {
        display: flex;
        gap: .75rem;
        overflow-x: auto;
        margin: 0 -.5rem 1.5rem;
        padding: .25rem .5rem .5rem;
        scroll-snap-type: x proximity;
    }
    .mechanic-status-scroll::-webkit-scrollbar {
        display: none;
    }
    .mechanic-status-chip {
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        color: rgba(255,255,255,0.85);
        border-radius: 14px;
        padding: .65rem .9rem;
        min-width: 126px;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: .45rem;
        align-items: center;
        font-size: .85rem;
        text-align: left;
        transition: all .2s ease;
        scroll-snap-align: center;
    }
    .mechanic-status-chip .chip-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.05rem;
    }
    .mechanic-status-chip .chip-label {
        font-weight: 600;
        line-height: 1.1;
    }
    .mechanic-status-chip .chip-count {
        background: rgba(0,0,0,0.25);
        border-radius: 999px;
        padding: .15rem .55rem;
        font-size: .7rem;
        font-weight: 600;
        text-align: center;
    }
    .mechanic-status-chip.active {
        border-color: rgba(193, 39, 45, 0.55);
        background: rgba(193, 39, 45, 0.18);
        color: #fff;
        box-shadow: 0 10px 24px rgba(193, 39, 45, 0.18);
    }
    .mechanic-status-chip[data-empty="true"] {
        opacity: .55;
    }
    .mechanic-status-chip[data-variant="diagnostico"] .chip-icon {
        color: #5bd0ff;
    }
    .mechanic-status-chip[data-variant="orcamento"] .chip-icon {
        color: #ffd166;
    }
    .mechanic-status-chip[data-variant="orcamento-enviado"] .chip-icon {
        color: #ffafcc;
    }
    .mechanic-status-chip[data-variant="aprovada"] .chip-icon {
        color: #8ae67c;
    }
    .mechanic-status-chip[data-variant="execucao"] .chip-icon {
        color: #ff6f61;
    }
    .mechanic-status-chip[data-variant="peca"] .chip-icon {
        color: #7bdff2;
    }

    .mechanic-card {
        transition: transform .2s ease, box-shadow .2s ease;
        position: relative;
        overflow: hidden;
    }
    .mechanic-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.35);
    }
    .mechanic-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: .75rem;
    }
    .mechanic-card-header h5 {
        font-size: 1rem;
    }
    .mechanic-status-badge {
        font-size: .75rem;
        border-radius: 999px;
        padding: .35rem .8rem;
    }
    .mechanic-card-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: .65rem;
    }
    .mechanic-card-meta .meta-label {
        display: block;
        font-size: .7rem;
        text-transform: uppercase;
        letter-spacing: .04em;
        color: rgba(255,255,255,0.5);
    }
    .mechanic-card-meta .meta-value {
        font-weight: 600;
        color: rgba(255,255,255,0.95);
    }
    .mechanic-card-progress .progress {
        height: 0.4rem;
        background: rgba(255,255,255,0.08);
    }
    .mechanic-card-progress .progress-bar {
        background: linear-gradient(90deg, rgba(193, 39, 45, 0.85) 0%, rgba(193, 39, 45, 0.55) 100%);
    }
    .mechanic-actions {
        display: flex;
        flex-direction: column;
        gap: .75rem;
    }
    .mechanic-actions form,
    .mechanic-actions a {
        width: 100%;
    }
    @media (max-width: 767.98px) {
        .mechanic-card {
            border-radius: 16px;
        }
        .mechanic-card-header h5 {
            font-size: 1.05rem;
        }
        .mechanic-status-scroll {
            margin-left: -1rem;
            margin-right: -1rem;
            padding-left: 1rem;
            padding-right: 1rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterButtons = document.querySelectorAll('[data-filter-status]');
    const cards = document.querySelectorAll('[data-status-card]');
    const emptyState = document.getElementById('mechanic-empty-filter');

    const updateEmptyState = () => {
        if (!emptyState) {
            return;
        }
        if (!cards.length) {
            emptyState.classList.add('d-none');
            return;
        }
        const anyVisible = Array.from(cards).some(card => !card.classList.contains('d-none'));
        emptyState.classList.toggle('d-none', anyVisible);
    };

    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const value = btn.getAttribute('data-filter-status');
            filterButtons.forEach(b => {
                b.classList.remove('active');
                b.setAttribute('aria-pressed', 'false');
            });
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
            if (typeof btn.scrollIntoView === 'function') {
                btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
            cards.forEach(card => {
                const status = card.getAttribute('data-status-card');
                if (value === 'ALL' || value === status) {
                    card.classList.remove('d-none');
                } else {
                    card.classList.add('d-none');
                }
            });
            updateEmptyState();
        });
    });

    updateEmptyState();
});
</script>
{% endblock %}

{% block content %}
<div class="mechanic-status-scroll" role="tablist" aria-label="Filtrar ordens por status">
    <button type="button" class="mechanic-status-chip active" data-filter-status="ALL" data-variant="all" aria-pressed="true">
        <span class="chip-icon"><i class="bi bi-grid"></i></span>
        <span class="chip-label">Todas</span>
        <span class="chip-count">{{ total_ordens }}</span>
    </button>
    {% for status in status_summary %}
    <button type="button"
            class="mechanic-status-chip"
            data-filter-status="{{ status.code }}"
            data-variant="{{ status.variant }}"
            data-empty="{% if status.count == 0 %}true{% else %}false{% endif %}"
            aria-pressed="false">
        <span class="chip-icon"><i class="bi {{ status.icon }}"></i></span>
        <span class="chip-label">{{ status.label }}</span>
        <span class="chip-count">{{ status.count }}</span>
    </button>
    {% endfor %}
</div>

<div class="row g-3">
    {% for ordem in ordens %}
        <div class="col-12 col-md-6 col-lg-4" data-status-card="{{ ordem.status }}">
            <div class="card mechanic-card h-100">
                <div class="card-body d-flex flex-column gap-3">
                    <div class="mechanic-card-header">
                        <div>
                            <div class="text-muted small fw-semibold">OS #{{ ordem.numero_os }}</div>
                            <h5 class="mb-1">{{ ordem.veiculo.placa }} · {{ ordem.veiculo.marca }} {{ ordem.veiculo.modelo }}</h5>
                            <div class="text-muted small d-flex align-items-center gap-2">
                                <i class="bi bi-person-circle"></i>
                                <span>{{ ordem.cliente.nome }}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge mechanic-status-badge bg-secondary">{{ ordem.get_status_display }}</span>
                        </div>
                    </div>

                    <p class="small text-muted mb-0">{{ ordem.descricao_problema|truncatewords:18 }}</p>

                    <div class="mechanic-card-meta small">
                        <div>
                            <span class="meta-label">Prioridade</span>
                            <span class="meta-value">{{ ordem.get_prioridade_display }}</span>
                        </div>
                        <div>
                            <span class="meta-label">Aberta em</span>
                            <span class="meta-value">{{ ordem.data_abertura|date:"d/m H:i" }}</span>
                        </div>
                        {% if ordem.prazo_entrega %}
                        <div>
                            <span class="meta-label">Prazo</span>
                            <span class="meta-value">{{ ordem.prazo_entrega|date:"d/m H:i" }}</span>
                        </div>
                        {% endif %}
                        {% if ordem.orcamento_total_estimado %}
                        <div>
                            <span class="meta-label">Estimado</span>
                            <span class="meta-value">R$ {{ ordem.orcamento_total_estimado|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        {% if ordem.status in ['APROVADA', 'EM_ANDAMENTO', 'AGUARDANDO_PECA'] %}
                        <div>
                            <span class="meta-label">Saldo pendente</span>
                            <span class="meta-value">
                                {% if ordem.saldo_pendente %}
                                    R$ {{ ordem.saldo_pendente|floatformat:2 }}
                                {% else %}
                                    Quitada
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    {% if ordem.status in ['APROVADA', 'EM_ANDAMENTO', 'AGUARDANDO_PECA'] %}
                    {% with percentual=ordem.percentual_pago saldo=ordem.saldo_pendente %}
                    <div class="mechanic-card-progress">
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span>Sinal recebido</span>
                            <span>{{ percentual|floatformat:0 }}%</span>
                        </div>
                        <div class="progress" role="presentation">
                            <div class="progress-bar" role="progressbar" style="width: {{ percentual|floatformat:0 }}%" aria-valuenow="{{ percentual|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        {% if saldo %}
                        <div class="small text-muted mt-1">Faltam R$ {{ saldo|floatformat:2 }} para quitar.</div>
                        {% else %}
                        <div class="small text-success mt-1">Saldo quitado.</div>
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% endif %}

                    {% if ordem.status == 'ORCAMENTO_ENVIADO' %}
                    <div class="alert alert-warning small mb-0">
                        Aguardando recepção enviar orçamento ao cliente.
                    </div>
                    {% elif ordem.status == 'AGUARDANDO_PECA' %}
                    <div class="alert alert-info small mb-0">
                        Aguardando chegada das peças. Avise a recepção quando estiverem em mãos.
                    </div>
                    {% endif %}

                    <div class="mechanic-actions">
                        {% if ordem.status == 'DIAGNOSTICO' or ordem.status == 'ORCAMENTO' %}
                            <a class="btn btn-outline-primary" href="{% url 'core:mecanico_diagnostico' ordem.id %}"><i class="bi bi-clipboard-plus me-1"></i>Registrar diagnóstico</a>
                            <div class="small text-muted">Finalize o diagnóstico para liberar o orçamento.</div>
                        {% elif ordem.status == 'APROVADA' %}
                            {% if ordem.sinal_atendido %}
                                <form class="d-grid" method="post" action="{% url 'core:mecanico_atualizar_status' ordem.id %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="acao" value="iniciar_execucao">
                                    <button class="btn btn-outline-success" type="submit"><i class="bi bi-play-fill me-1"></i>Iniciar execução</button>
                                </form>
                                <form class="d-grid" method="post" action="{% url 'core:mecanico_atualizar_status' ordem.id %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="acao" value="aguardar_peca">
                                    <button class="btn btn-outline-warning" type="submit"><i class="bi bi-box-seam me-1"></i>Aguardando peça</button>
                                </form>
                                <div class="small text-muted">Escolha iniciar o serviço ou aguardar peças.</div>
                            {% else %}
                                <div class="alert alert-warning small mb-0">
                                    Aguardando confirmação de sinal (R$ {{ ordem.valor_minimo_sinal|floatformat:2 }}).
                                </div>
                            {% endif %}
                        {% elif ordem.status == 'EM_ANDAMENTO' %}
                            <form class="d-grid" method="post" action="{% url 'core:mecanico_atualizar_status' ordem.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="acao" value="aguardar_peca">
                                <button class="btn btn-outline-warning" type="submit"><i class="bi bi-box-seam me-1"></i>Aguardando peça</button>
                            </form>
                            <form class="d-grid" method="post" action="{% url 'core:mecanico_atualizar_status' ordem.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="acao" value="concluir_execucao">
                                <button class="btn btn-outline-success" type="submit"><i class="bi bi-check2-circle me-1"></i>Concluir execução</button>
                            </form>
                        {% elif ordem.status == 'AGUARDANDO_PECA' %}
                            <form class="d-grid" method="post" action="{% url 'core:mecanico_atualizar_status' ordem.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="acao" value="retomar_execucao">
                                <button class="btn btn-outline-primary" type="submit"><i class="bi bi-play-fill me-1"></i>Retomar execução</button>
                            </form>
                            <div class="small text-muted">Atualize quando as peças chegarem.</div>
                        {% endif %}
                        <a class="btn btn-outline-secondary" href="{% url 'core:detalhes_ordem_servico' ordem.id %}"><i class="bi bi-eye me-1"></i>Ver detalhes</a>
                    </div>
                </div>
            </div>
        </div>
    {% empty %}
        <div class="col-12">
            <div class="text-center text-muted py-5">
                <i class="bi bi-clipboard-x fs-1 d-block mb-3"></i>
                Nenhuma ordem atribuída para você.
            </div>
        </div>
    {% endfor %}
</div>

<div id="mechanic-empty-filter" class="text-center text-muted py-5 d-none">
    <i class="bi bi-inboxes fs-1 d-block mb-3"></i>
    Nada por aqui nesse status por enquanto.
</div>
{% endblock %}
